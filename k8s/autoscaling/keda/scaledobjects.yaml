# =============================================================================
# KEDA - Kubernetes Event-Driven Autoscaling
# =============================================================================
#
# KEDA enables scale-to-zero for GKE workers by monitoring Pub/Sub queue depth.
#
# Benefits:
#   - Scale to 0 pods when queue is empty (massive cost savings)
#   - Automatically wake up when messages arrive
#   - Works with GKE Autopilot
#
# Trade-offs:
#   - Cold start delay (2-5 minutes for GPU workloads)
#   - More complex than standard HPA
#
# Installation:
#   helm repo add kedacore https://kedacore.github.io/charts
#   helm install keda kedacore/keda --namespace keda --create-namespace
#
# Usage:
#   kubectl apply -f k8s/autoscaling/keda/
#
# =============================================================================

# -----------------------------------------------------------------------------
# GCP Authentication (using Workload Identity)
# -----------------------------------------------------------------------------
apiVersion: keda.sh/v1alpha1
kind: TriggerAuthentication
metadata:
  name: gcp-pubsub-auth
  namespace: imagen
spec:
  podIdentity:
    provider: gcp

---
# -----------------------------------------------------------------------------
# Upscale Worker - Scale to Zero
# -----------------------------------------------------------------------------
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: upscale-worker-keda
  namespace: imagen
spec:
  scaleTargetRef:
    name: upscale-worker
  
  # Scale to zero when idle!
  minReplicaCount: 0
  maxReplicaCount: 10
  
  # Wait 5 minutes of empty queue before scaling to 0
  cooldownPeriod: 300
  
  # Check queue every 15 seconds
  pollingInterval: 15
  
  # Advanced settings
  advanced:
    restoreToOriginalReplicaCount: false
    horizontalPodAutoscalerConfig:
      behavior:
        scaleUp:
          stabilizationWindowSeconds: 60
          policies:
            - type: Pods
              value: 4
              periodSeconds: 60
        scaleDown:
          stabilizationWindowSeconds: 300
          policies:
            - type: Pods
              value: 1
              periodSeconds: 120
  
  triggers:
    - type: gcp-pubsub
      authenticationRef:
        name: gcp-pubsub-auth
      metadata:
        subscriptionName: upscale-jobs-sub
        # Scale when messages per pod exceeds this
        subscriptionSize: "2"
        # Wake up from zero when at least 1 message
        activationSubscriptionSize: "1"

---
# -----------------------------------------------------------------------------
# Enhance Worker - Scale to Zero
# -----------------------------------------------------------------------------
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: enhance-worker-keda
  namespace: imagen
spec:
  scaleTargetRef:
    name: enhance-worker
  minReplicaCount: 0
  maxReplicaCount: 10
  cooldownPeriod: 300
  pollingInterval: 15
  triggers:
    - type: gcp-pubsub
      authenticationRef:
        name: gcp-pubsub-auth
      metadata:
        subscriptionName: enhance-jobs-sub
        subscriptionSize: "2"
        activationSubscriptionSize: "1"

---
# -----------------------------------------------------------------------------
# Comic Style Worker - Scale to Zero
# -----------------------------------------------------------------------------
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: comic-worker-keda
  namespace: imagen
spec:
  scaleTargetRef:
    name: comic-worker
  minReplicaCount: 0
  maxReplicaCount: 10
  cooldownPeriod: 300
  pollingInterval: 15
  triggers:
    - type: gcp-pubsub
      authenticationRef:
        name: gcp-pubsub-auth
      metadata:
        subscriptionName: style-comic-jobs-sub
        subscriptionSize: "2"
        activationSubscriptionSize: "1"

---
# -----------------------------------------------------------------------------
# Background Remove Worker - Scale to Zero
# -----------------------------------------------------------------------------
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: background-remove-worker-keda
  namespace: imagen
spec:
  scaleTargetRef:
    name: background-remove-worker
  minReplicaCount: 0
  maxReplicaCount: 10
  cooldownPeriod: 300
  pollingInterval: 15
  triggers:
    - type: gcp-pubsub
      authenticationRef:
        name: gcp-pubsub-auth
      metadata:
        subscriptionName: background-remove-jobs-sub
        subscriptionSize: "2"
        activationSubscriptionSize: "1"
